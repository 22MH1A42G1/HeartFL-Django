{% extends 'base.html' %}

{% block content %}
<div class="fade-in-up">
    {% if prediction_result %}
        <!-- Prediction Result -->
        <div class="glass-card mb-4">
            <h2 class="text-center fw-bold mb-4">
                <i class="bi bi-clipboard-check-fill text-success"></i> Prediction Result
            </h2>
            
            <div class="row">
                <div class="col-md-6">
                    <h5 class="fw-bold mb-3">Patient Information</h5>
                    <table class="table table-sm">
                        <tr>
                            <th>Name:</th>
                            <td>{{ prediction_result.patient_data.patient_name }}</td>
                        </tr>
                        <tr>
                            <th>Age:</th>
                            <td>{{ prediction_result.patient_data.age }} years</td>
                        </tr>
                        <tr>
                            <th>Gender:</th>
                            <td>{{ prediction_result.patient_data.get_gender_display }}</td>
                        </tr>
                        <tr>
                            <th>Chest Pain Type:</th>
                            <td>Type {{ prediction_result.patient_data.chest_pain_type }}</td>
                        </tr>
                        <tr>
                            <th>Resting BP:</th>
                            <td>{{ prediction_result.patient_data.resting_bp }} mm Hg</td>
                        </tr>
                        <tr>
                            <th>Max Heart Rate:</th>
                            <td>{{ prediction_result.patient_data.max_heart_rate }}</td>
                        </tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <div class="text-center">
                        {% if prediction_result.prediction == 'high' %}
                            <div class="display-1 text-danger mb-2">
                                <i class="bi bi-exclamation-triangle-fill"></i>
                            </div>
                            <h3 class="fw-bold text-danger">HIGH RISK</h3>
                        {% else %}
                            <div class="display-1 text-success mb-2">
                                <i class="bi bi-check-circle-fill"></i>
                            </div>
                            <h3 class="fw-bold text-success">LOW RISK</h3>
                        {% endif %}
                        
                        <div class="mt-3">
                            <div class="progress" style="height: 30px;">
                                <div class="progress-bar {% if prediction_result.prediction == 'high' %}bg-danger{% else %}bg-success{% endif %}" 
                                     role="progressbar" 
                                     style="width: {{ prediction_result.confidence_score }}%;">
                                    <strong>{{ prediction_result.confidence_score|floatformat:2 }}%</strong>
                                </div>
                            </div>
                            <p class="text-muted mt-2">Confidence Score</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="alert {% if prediction_result.prediction == 'high' %}alert-danger{% else %}alert-success{% endif %} mt-4">
                <h5 class="fw-bold">
                    <i class="bi bi-info-circle-fill"></i> Recommendation
                </h5>
                {% if prediction_result.prediction == 1 %}
                    <p class="mb-0">
                        The patient shows indicators of <strong>high heart disease risk</strong>. 
                        Immediate medical consultation and further diagnostic tests are recommended. 
                        Consider lifestyle modifications and potential medical intervention.
                    </p>
                {% else %}
                    <p class="mb-0">
                        The patient shows <strong>low indicators of heart disease risk</strong>. 
                        Continue with regular health checkups and maintain a healthy lifestyle. 
                        Monitor cardiovascular health periodically.
                    </p>
                {% endif %}
            </div>

            <div class="d-grid gap-2 mt-4">
                <a href="{% url 'prediction:download_report' prediction_result.id %}" class="btn btn-success btn-lg">
                    <i class="bi bi-file-earmark-pdf-fill"></i> Download PDF Report
                </a>
                <a href="{% url 'prediction:predict' %}" class="btn btn-primary btn-lg">
                    <i class="bi bi-plus-circle"></i> New Prediction
                </a>
                <a href="{% url 'prediction:history' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-clock-history"></i> View History
                </a>
            </div>
        </div>
    {% else %}
        <!-- Prediction Form -->
        <div class="glass-card mb-4">
            <h2 class="text-center fw-bold mb-4">
                <i class="bi bi-heart-pulse-fill text-danger"></i> Heart Disease Prediction
            </h2>
            <p class="text-center text-muted mb-4">Enter patient health data for risk assessment</p>

            <form method="post">
                {% csrf_token %}
                
                <h5 class="fw-bold mb-3 text-primary">
                    <i class="bi bi-person-fill"></i> Patient Information
                </h5>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">{{ form.patient_name.label }}</label>
                        {{ form.patient_name }}
                        {% if form.patient_name.errors %}<small class="text-danger">{{ form.patient_name.errors }}</small>{% endif %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Age (years)</label>
                        {{ form.age }}
                        {% if form.age.errors %}<small class="text-danger">{{ form.age.errors }}</small>{% endif %}
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Gender</label>
                        {{ form.gender }}
                        {% if form.gender.errors %}<small class="text-danger">{{ form.gender.errors }}</small>{% endif %}
                    </div>
                </div>

                <hr class="my-4">

                <h5 class="fw-bold mb-3 text-success">
                    <i class="bi bi-activity"></i> Clinical Measurements
                </h5>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">{{ form.chest_pain_type.label }}</label>
                        {{ form.chest_pain_type }}
                        {% if form.chest_pain_type.errors %}<small class="text-danger">{{ form.chest_pain_type.errors }}</small>{% endif %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">{{ form.resting_bp.label }}</label>
                        {{ form.resting_bp }}
                        {% if form.resting_bp.errors %}<small class="text-danger">{{ form.resting_bp.errors }}</small>{% endif %}
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">{{ form.cholesterol.label }}</label>
                        {{ form.cholesterol }}
                        {% if form.cholesterol.errors %}<small class="text-danger">{{ form.cholesterol.errors }}</small>{% endif %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">{{ form.max_heart_rate.label }}</label>
                        {{ form.max_heart_rate }}
                        {% if form.max_heart_rate.errors %}<small class="text-danger">{{ form.max_heart_rate.errors }}</small>{% endif %}
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">{{ form.resting_ecg.label }}</label>
                        {{ form.resting_ecg }}
                        {% if form.resting_ecg.errors %}<small class="text-danger">{{ form.resting_ecg.errors }}</small>{% endif %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">{{ form.st_slope.label }}</label>
                        {{ form.st_slope }}
                        {% if form.st_slope.errors %}<small class="text-danger">{{ form.st_slope.errors }}</small>{% endif %}
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">{{ form.oldpeak.label }}</label>
                        {{ form.oldpeak }}
                        {% if form.oldpeak.errors %}<small class="text-danger">{{ form.oldpeak.errors }}</small>{% endif %}
                    </div>
                    <div class="col-md-6">
                        <div class="mt-4">
                            <div class="form-check">
                                {{ form.fasting_bs }}
                                <label class="form-check-label fw-bold" for="id_fasting_bs">
                                    {{ form.fasting_bs.label }}
                                </label>
                            </div>
                            <div class="form-check mt-2">
                                {{ form.exercise_angina }}
                                <label class="form-check-label fw-bold" for="id_exercise_angina">
                                    {{ form.exercise_angina.label }}
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-grid gap-2 mt-4">
                    <button type="submit" class="btn btn-danger btn-lg btn-glow">
                        <i class="bi bi-graph-up"></i> Predict Heart Disease Risk
                    </button>
                </div>
            </form>
        </div>

        <div class="glass-card">
            <h5 class="fw-bold mb-3">
                <i class="bi bi-info-circle-fill text-info"></i> About This Prediction
            </h5>
            <p class="mb-2">
                This prediction uses a machine learning model trained using <strong>Federated Learning</strong> 
                across multiple hospitals. The model analyzes patient health parameters to assess heart disease risk.
            </p>
            <p class="mb-0">
                <strong>Note:</strong> This is a screening tool. Always consult with healthcare professionals 
                for proper diagnosis and treatment.
            </p>
        </div>
    {% endif %}
</div>
{% endblock %}
